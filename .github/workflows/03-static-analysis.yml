---
name: '03 ðŸ”Ž Static analysis'

# yamllint disable-line rule:truthy
on:
  workflow_run:
    workflows: [ '02 ðŸ‘ŠðŸ½ Auto version bump' ]
    types:
      - completed

env:
  NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
  OSS_INDEX_USER: ${{ secrets.OSS_INDEX_USER }}
  OSS_INDEX_API_KEY: ${{ secrets.OSS_INDEX_API_KEY }}

jobs:
  # Download version metadata from the triggering (02) run; deserialize for downstream jobs
  get-version-metadata:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      bumped: ${{ steps.version.outputs.bumped }}
      next_version: ${{ steps.version.outputs.next_version }}
    steps:
      # Official action requires github-token + run-id for cross-run download; use community action
      # when artifact may be missing (e.g. 02's bump-version was skipped) so the job does not fail
      - uses: dawidd6/action-download-artifact@v6
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: version-metadata
          if_no_artifact_found: ignore
      - id: version
        run: |
          if [ -f version.json ]; then
            echo "bumped=$(jq -r '.bumped' version.json)" >> "$GITHUB_OUTPUT"
            echo "next_version=$(jq -r '.next' version.json)" >> "$GITHUB_OUTPUT"
          else
            echo "bumped=false" >> "$GITHUB_OUTPUT"
            echo "next_version=" >> "$GITHUB_OUTPUT"
          fi

  static-analysis:
    needs: [ get-version-metadata ]
    if: needs.get-version-metadata.outputs.bumped == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/tools
      - run: task build:sa

  publish-trigger:
    needs: [ get-version-metadata, static-analysis ]
    runs-on: ubuntu-latest
    steps:
      - uses: peter-evans/repository-dispatch@v4
        with:
          event-type: publish-packages
          client-payload: '{"version": "${{ needs.get-version-metadata.outputs.next_version }}"}'
