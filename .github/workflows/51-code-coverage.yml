---
name: 51 ☘️ Code coverage

# yamllint disable-line rule:truthy
on:
  # Run weekly, Sunday afternoon PST
  schedule:
    - cron: '0 23 * * 0'

# need ID token write permission to use OIDC
# need actions: read to access artifacts from other jobs
permissions:
  contents: read
  # id-token: write
  actions: read

jobs:
  code-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Needed for commit range checks
          ref: main  # check out the branch, not detached HEAD
      - uses: ./.github/actions/tools
      - run: task -t .github/taskfile.build.yml install
      - run: task -t .github/taskfile.clover.yml clover-unit
      - run: task -t .github/taskfile.clover.yml clover-report
      - if: always()
        uses: actions/upload-artifact@v7
        with:
          name: coverage-report
          path: target/site/clover/**
          retention-days: 30
          if-no-files-found: warn
      # Extract coverage summary and generate job summary
      - if: always()
        id: coverage
        run: .github/scripts/coverage-summary.sh target/site/clover/clover.xml
      - if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: target/site/clover/clover.xml
          codecov_yml_path: .github/.codecov.yml
          fail_ci_if_error: false
          handle_no_reports_found: true
