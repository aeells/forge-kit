---
name: '02 ğŸ‘ŠğŸ½ Auto version bump'

# yamllint disable-line rule:truthy
on:
  workflow_run:
    workflows: [ '01 ğŸš§ Build and test' ]
    types:
      - completed

permissions:
  contents: write  # Required to push commits/tags directly to main
  actions: write  # Required for repository_dispatch

jobs:
  # âœ… Commitizen + Maven versioning in sync
  # âœ… Automatic changelog updates
  # âœ… Clean semver tags (vX.Y.Z)
  # âœ… feat: or fix: commit â†’ CI automation run bumps version, syncs .cz.toml, updates POMs, creates + pushes tag
  bump-version:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.actor != 'renovate[bot]' }}
    runs-on: ubuntu-latest
    outputs:
      bumped: ${{ steps.version-bump.outputs.bumped }}
      current_version: ${{ steps.version-bump.outputs.current_version }}
      next_version: ${{ steps.version-bump.outputs.next_version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Needed for commit range checks
          ref: main  # check out the branch, not detached HEAD
      - uses: ./.github/actions/tools
      - id: version-bump
        run: .github/scripts/version-bump.sh
      - if: steps.version-bump.outputs.bumped == 'true'
        uses: ad-m/github-push-action@master
        with:
          branch: main
          tags: true
          force: false
      - run: .github/scripts/version-bump-summary.sh
        env:
          BUMPED: ${{ steps.version-bump.outputs.bumped }}
          CURRENT_VERSION: ${{ steps.version-bump.outputs.current_version }}
          NEXT_VERSION: ${{ steps.version-bump.outputs.next_version }}

  publish-trigger:
    needs: bump-version
    if: needs.bump-version.outputs.bumped == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: peter-evans/repository-dispatch@v4
        with:
          event-type: publish-packages
          client-payload: '{"version": "${{ needs.bump-version.outputs.next_version }}"}'
