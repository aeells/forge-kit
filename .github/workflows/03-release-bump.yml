---
name: '03 üëäüèΩ Auto version bump'

# yamllint disable-line rule:truthy
on:
  workflow_run:
    workflows: [ '02 üîé Static analysis' ]
    types:
      - completed

permissions:
  contents: write  # Required to push commits/tags directly to main
  actions: write  # Required for repository_dispatch

jobs:
  # ‚úÖ Commitizen + Maven versioning in sync
  # ‚úÖ Automatic changelog updates
  # ‚úÖ Clean semver tags (vX.Y.Z)
  # ‚úÖ feat: or fix: commit ‚Üí CI automation run bumps version, syncs .cz.toml, updates POMs, creates + pushes tag
  bump-version:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.actor != 'renovate[bot]' }}
    runs-on: ubuntu-latest
    outputs:
      bumped: ${{ steps.version-bump.outputs.bumped }}
      current_version: ${{ steps.version-bump.outputs.current_version }}
      next_version: ${{ steps.version-bump.outputs.next_version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Needed for commit range checks
          ref: main  # check out the branch, not detached HEAD
      # Import GPG key so commits/tags are signed and show as Verified (required for branch protection "Require signed commits")
      # Store key as BASE64 to avoid "No key packet found" (GitHub Secrets can strip newlines from pasted armored keys).
      # Generate: gpg --armor --export-secret-keys YOUR_KEY_ID | base64 -w 0  (Linux) or ... | base64 | tr -d '\n'  (macOS)
      # Repo secrets: GPG_PRIVATE_KEY (base64-encoded armoured key), GPG_PASSPHRASE
      - uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_config_global: true
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_tag_gpgsign: true
      - uses: ./.github/actions/tools
      - id: version-bump
        run: .github/scripts/version-bump.sh
      - if: steps.version-bump.outputs.bumped == 'true'
        uses: ad-m/github-push-action@master
        with:
          branch: main
          tags: true
          force: false
      - run: .github/scripts/version-bump-summary.sh
        env:
          BUMPED: ${{ steps.version-bump.outputs.bumped }}
          CURRENT_VERSION: ${{ steps.version-bump.outputs.current_version }}
          NEXT_VERSION: ${{ steps.version-bump.outputs.next_version }}

  publish-trigger:
    needs: bump-version
    if: needs.bump-version.outputs.bumped == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: peter-evans/repository-dispatch@v4
        with:
          event-type: publish-packages
          client-payload: '{"version": "${{ needs.bump-version.outputs.next_version }}"}'
